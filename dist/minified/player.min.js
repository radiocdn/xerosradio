class RadioPlayer{constructor(){this.radioPlayer=document.getElementById("radioPlayer"),this.artistInfo=document.getElementById("artistInfo"),this.titleInfo=document.getElementById("titleInfo"),this.albumArtwork=document.getElementById("albumArtwork"),this.djInfoElement=document.getElementById("djInfo"),this.artworkElement=document.getElementById("artwork"),this.playPauseButton=document.getElementById("playPauseButton"),this.volumeSlider=document.getElementById("volumeSlider"),this.castButton=document.getElementById("castButton"),this.isPlaying=!1,this.userPaused=!1,this.lastCastTitle="",this.lastCastArtist="",this.castSessionLoaded=!1,this.playPauseButton.addEventListener("click",this.togglePlay.bind(this)),this.volumeSlider.addEventListener("input",this.adjustVolume.bind(this)),this.castButton.addEventListener("click",this.castButtonClick.bind(this)),this.volumeSlider.value=this.getVolumeFromCookie()||.5,this.radioPlayer.volume=this.volumeSlider.value,this.updateRadioInfo(),setInterval(this.updateRadioInfo.bind(this),5e3),this.initializeCastSDK(),this.setupMediaSession(),this.radioPlayer.addEventListener("error",this.handleStreamError.bind(this)),this.radioPlayer.addEventListener("stalled",this.handleStreamError.bind(this)),this.radioPlayer.addEventListener("ended",this.handleStreamError.bind(this)),this.radioPlayer.addEventListener("pause",this.handlePause.bind(this)),this.reconnectDelay=3e3}isValidUrl(a){try{return new URL(a),!0}catch{return!1}}async updateRadioInfo(){try{const a=await fetch("https://xerosradioapiprd.global.ssl.fastly.net/",{method:"GET",cache:"no-cache"});if(!a.ok)throw new Error("Verzoek aan de XerosRadio Servers is mislukt.");const b=await a.json(),{artist:c,title:d,cover_art200x200:e}=b.current_song,{dj_live_status:f,dj_name:g,dj_cover:h}=b.onair_info,i=e||"https://res.cloudinary.com/xerosradio/image/upload/w_200,h_200,f_webp,q_auto/XerosRadio_Logo_Achtergrond_Wit";this.artistInfo.textContent=c,this.titleInfo.textContent=d,this.albumArtwork.src=i;const j=c!==this.lastCastArtist||d!==this.lastCastTitle;if(j&&(this.updateMediaMetadata(c,d,i,i),this.lastCastArtist=c,this.lastCastTitle=d,this.isCasting()&&this.updateCastMetadata(c,d,i)),f){this.djInfoElement.textContent=g;const a=this.isValidUrl(h)?h:"https://res.cloudinary.com/xerosradio/image/upload/w_200,h_200,f_webp,q_auto/XerosRadio_Logo_Achtergrond_Wit",b=new Image;b.src=a,b.onerror=()=>{b.src="https://res.cloudinary.com/xerosradio/image/upload/w_200,h_200,f_webp,q_auto/XerosRadio_Logo_Achtergrond_Wit"},b.draggable=!1,b.loading="lazy",b.alt="XerosRadio DJ",b.style.width="200px",b.style.height="200px",this.artworkElement.innerHTML="",this.artworkElement.appendChild(b)}else this.djInfoElement.textContent="Nonstop Muziek",this.artworkElement.innerHTML=`<img src="${h}" alt="XerosRadio Nonstop Muziek" draggable="false" loading="lazy" style="width: 200px; height: 200px;">`}catch(a){this.handleError(a)}}handleError(a){console.error("Fout:",a),this.djInfoElement.textContent="XerosRadio is momenteel niet beschikbaar. Probeer het later opnieuw.",this.artworkElement.innerHTML=`<img src="https://res.cloudinary.com/xerosradio/image/upload/w_200,h_200,f_webp,q_auto/XerosRadio_Logo_Achtergrond_Wit" alt="XerosRadio" draggable="false" loading="lazy" style="width: 200px; height: 200px;">`}initializeCastSDK(){window.__onGCastApiAvailable=a=>{if(a){const a=cast.framework.CastContext.getInstance();a.setOptions({receiverApplicationId:chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,autoJoinPolicy:chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED}),a.addEventListener(cast.framework.CastContextEventType.SESSION_STATE_CHANGED,a=>this.handleCastSessionState(a))}}}handleCastSessionState(a){a.sessionState===cast.framework.SessionState.SESSION_STARTED?(!this.castSessionLoaded&&(this.loadMediaToCast(),this.castSessionLoaded=!0),this.pauseMedia()):a.sessionState===cast.framework.SessionState.SESSION_ENDED&&(this.castSessionLoaded=!1,this.playMedia())}isCasting(){const a=cast.framework.CastContext.getInstance().getCurrentSession();return a&&a.getMediaSession()}updateCastMetadata(a,b,c){const d=cast.framework.CastContext.getInstance().getCurrentSession();if(d){const e=d.getMediaSession();if(e){const d=new chrome.cast.media.MusicTrackMediaMetadata;d.title=b,d.artist=a,d.images=[{url:c}],e.media.metadata=d}}}castButtonClick(){const a=cast.framework.CastContext.getInstance();a.requestSession().then(()=>this.loadMediaToCast()).catch(a=>console.error("Error starting session:",a))}loadMediaToCast(){const a=cast.framework.CastContext.getInstance().getCurrentSession();if(a){const b=new chrome.cast.media.MediaInfo("https://stream.streamxerosradio.duckdns.org/xerosradio","audio/mpeg"),c=new chrome.cast.media.MusicTrackMediaMetadata;c.title=this.lastCastTitle||"XerosRadio",c.artist=this.lastCastArtist||"Live",c.images=[{url:this.albumArtwork?.src||"https://res.cloudinary.com/xerosradio/image/upload/f_webp,q_auto/XerosRadio_Logo"}],b.metadata=c;const d=new chrome.cast.media.LoadRequest(b);a.loadMedia(d).then(()=>console.log("Media succesvol geladen naar cast.")).catch(a=>console.error("Fout bij laden van media naar cast:",a))}}setupMediaSession(){"mediaSession"in navigator&&(navigator.mediaSession.setActionHandler("play",this.playMedia.bind(this)),navigator.mediaSession.setActionHandler("pause",this.pauseMedia.bind(this)),navigator.mediaSession.setActionHandler("stop",this.pauseMedia.bind(this)))}updateMediaMetadata(a,b,c,d){"mediaSession"in navigator&&(navigator.mediaSession.metadata=new MediaMetadata({title:b,artist:a,artwork:[{src:d,sizes:"500x500",type:"image/webp"},{src:c,sizes:"200x200",type:"image/webp"}]}))}togglePlay(){this.isPlaying?(this.userPaused=!0,this.pauseMedia()):(this.userPaused=!1,this.playMedia())}playMedia(){this.radioPlayer.src="https://stream.streamxerosradio.duckdns.org/xerosradio",this.radioPlayer.play().then(()=>{this.isPlaying=!0,this.updatePlayPauseButton()}).catch(a=>{console.error("Fout bij afspelen:",a),setTimeout(()=>this.playMedia(),this.reconnectDelay)})}pauseMedia(){this.radioPlayer.pause(),this.isPlaying=!1,this.updatePlayPauseButton()}updatePlayPauseButton(){this.playPauseButton.className=this.isPlaying?"fas fa-pause":"fas fa-play"}adjustVolume(){this.radioPlayer.volume=this.volumeSlider.value,this.saveVolumeToCookie(this.volumeSlider.value)}saveVolumeToCookie(a){const b=new Date;b.setFullYear(b.getFullYear()+1),document.cookie=`volume=${a}; expires=${b.toUTCString()}; path=/`}getVolumeFromCookie(){const a=document.cookie.split(";").find(a=>a.trim().startsWith("volume="));return a?parseFloat(a.split("=")[1]):null}handleStreamError(){this.userPaused||(console.warn("Stream onderbroken. Poging tot opnieuw verbinden..."),setTimeout(()=>this.playMedia(),this.reconnectDelay))}handlePause(){this.userPaused||this.radioPlayer.ended||(console.warn("Speler gepauzeerd (mogelijk door fout). Probeer opnieuw te verbinden..."),setTimeout(()=>this.playMedia(),this.reconnectDelay))}}const radioPlayer=new RadioPlayer;